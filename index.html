<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>iwannasun</title>
  <style>
    :root {
      --bg: #f9f9f7;
      --card: #ffffff;
      --text: #333333;
      --muted: rgba(51,51,51,0.65);
      --good: #333333;
      --warn: #f4b860;
      --bad: #ff8c72;
      --accent-blue: #9bbed9;
      --line: rgba(51,51,51,0.10);
      --sunset: linear-gradient(90deg, #f4b860, #ff8c72);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      color-scheme: light;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: linear-gradient(180deg, #F9F9F7 0%, #E8DCC6 100%);
      color: var(--text);
    }
    header {
      padding: 16px 18px;
      border-bottom: 1px solid var(--line);
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      background: rgba(249,249,247,0.9);
      backdrop-filter: blur(10px);
      z-index: 10;
    }
    header h1 {
      margin: 0;
      font-size: 16px;
      letter-spacing: 0.2px;
    }
    header .sub {
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
    }
    .wrap {
      max-width: 980px;
      margin: 0 auto;
      padding: 18px;
    }
    .grid {
      display: grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 14px;
    }
    @media (max-width: 860px) {
      .grid { grid-template-columns: 1fr; }
    }
    .card {
      background: linear-gradient(180deg, #ffffff, #F9F9F7);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
    }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .row > * { flex: none; }
    .pill {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.03);
      color: var(--text);
      font-size: 12px;
    }
    button {
      border: 1px solid var(--line);
      background: rgba(244,184,96,0.10);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 13px;
    }
    button:hover { background: rgba(244,184,96,0.16); }
    input, select {
      border: 1px solid var(--line);
      background: rgba(249,249,247,0.9);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 13px;
      outline: none;
    }
    .kpi {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .kpi .box {
      padding: 10px;
      border-radius: 12px;
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--line);
    }
    .kpi .label { font-size: 11px; color: var(--muted); }
    .kpi .value { font-size: 20px; margin-top: 2px; }
    .muted { color: var(--muted); }
    .big {
      font-size: 22px;
      margin: 8px 0 0;
      letter-spacing: 0.2px;
    }
    .good { color: var(--good); }
    .warn { color: var(--warn); }
    .bad { color: var(--bad); }

    .timeline {
      margin-top: 12px;
      border-top: 1px solid var(--line);
      padding-top: 10px;
      max-height: 460px;
      overflow: auto;
    }
    .trow {
      display: grid;
      grid-template-columns: 70px 1fr 60px;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      font-size: 13px;
    }
    .bar {
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      overflow: hidden;
      margin-top: 5px;
    }
    .bar > div {
      height: 100%;
      border-radius: 999px;
      background: var(--sunset);
      width: 0%;
    }

    canvas {
      width: 100%;
      height: 220px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(155,190,217,0.08);
      margin-top: 10px;
    }

    .footer {
      margin-top: 14px;
      color: var(--muted);
      font-size: 12px;
      text-align: center;
    }

    .err {
      margin-top: 10px;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid rgba(251,113,133,0.35);
      background: rgba(251,113,133,0.08);
      color: #fecdd3;
      font-size: 13px;
      display: none;
    }

    .small { font-size: 12px; }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>iwannasun</h1>
      <div class="sub">Will I get direct sunlight here?</div>
    </div>
    <div class="row">
      <span class="pill" id="locPill">—</span>
      <button id="btnHere">Use my location</button>
      <button id="btnDemo">Demo</button>
    </div>
  </header>

  <div class="wrap">
    <div class="grid">
      <div class="card">
        <div class="row" style="justify-content: space-between;">
          <div>
            <div class="muted small">Decision</div>
            <div class="big" id="rightNow">—</div>
          </div>
          <div class="row">
            <label class="muted small">Threshold</label>
            <input id="threshold" type="number" min="0" max="100" value="70" style="width:84px" />
            <select id="daySelect">
              <option value="0">Today</option>
              <option value="1">Tomorrow</option>
            </select>
            <button id="btnRefresh">Refresh</button>
          </div>
        </div>

        <div class="kpi">
          <div class="box">
            <div class="label">Sun score now</div>
            <div class="value" id="scoreNow">—</div>
          </div>
          <div class="box">
            <div class="label">Confidence now</div>
            <div class="value" id="confNow">—</div>
          </div>
          <div class="box">
            <div class="label">Sunny minutes next 1h</div>
            <div class="value" id="sun60">—</div>
          </div>
          <div class="box">
            <div class="label">Sunny minutes next 2h</div>
            <div class="value" id="sun120">—</div>
          </div>
        </div>

        <div class="small" id="chartTitle" style="margin-top:10px; opacity:0.85">Elevation (°) — sunny segments ≥ 70</div>
        <canvas id="sunChart" width="900" height="250"></canvas>

        <div class="timeline" id="timeline"></div>
        <div class="err" id="errBox"></div>
      </div>

      <div class="card">
        <div class="muted small">Next sunny window</div>
        <div class="big" id="nextWindow">—</div>
        <div class="muted" id="nextWindowSub" style="margin-top:6px">—</div>

        <div style="margin-top: 14px; border-top: 1px solid var(--line); padding-top: 12px;">
          <div class="muted small">Notes</div>
          <div class="muted small" style="line-height:1.45; margin-top:6px">
            Sun Score is the probability of direct sun reaching you (0–100). Not a weather forecast.
            Low sun = distant clouds matter more.
          </div>
        </div>
      </div>
    </div>

    <div class="footer">Built for decisions: go now vs wait.</div>
  </div>

<script>
  const API_BASE = "https://iwannasun.onrender.com";
  const locPill = document.getElementById('locPill');
  const errBox = document.getElementById('errBox');

  const rightNow = document.getElementById('rightNow');
  const scoreNow = document.getElementById('scoreNow');
  const confNow = document.getElementById('confNow');
  const sun60 = document.getElementById('sun60');
  const sun120 = document.getElementById('sun120');

  const thresholdEl = document.getElementById('threshold');
  const daySelect = document.getElementById('daySelect');

  const nextWindow = document.getElementById('nextWindow');
  const nextWindowSub = document.getElementById('nextWindowSub');

  const timelineEl = document.getElementById('timeline');
  const canvas = document.getElementById('sunChart');
  const ctx = canvas.getContext('2d');

  let state = {
    lat: null,
    lon: null,
    tz: null,
    data: null,
  };

  function showError(msg) {
    errBox.style.display = 'block';
    errBox.textContent = msg;
  }
  function clearError() {
    errBox.style.display = 'none';
    errBox.textContent = '';
  }

  function fmtTime(iso) {
    const d = new Date(iso);
    return d.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
  }

  function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }

  function scoreClass(score, threshold) {
    if (score >= threshold) return 'good';
    if (score >= threshold - 15) return 'warn';
    return 'bad';
  }

  function computeNextWindow(dayRows, threshold) {
    // Find next contiguous window of >= threshold for min 20 min
    const now = new Date();

    // Future rows only
    const future = dayRows.filter(r => new Date(r.time_local) >= now);
    if (!future.length) return null;

    let start = null;
    let count = 0;

    for (let i = 0; i < future.length; i++) {
      const ok = future[i].sun_score >= threshold;
      if (ok) {
        if (!start) start = future[i];
        count += 10;
      } else {
        if (start && count >= 20) {
          return { start: start.time_local, end: future[i].time_local, minutes: count };
        }
        start = null;
        count = 0;
      }
    }

    if (start && count >= 20) {
      // End at last + 10
      const end = new Date(future[future.length - 1].time_local);
      end.setMinutes(end.getMinutes() + 10);
      return { start: start.time_local, end: end.toISOString(), minutes: count };
    }

    return null;
  }

  function renderDecision(nowRow, threshold) {
    if (!nowRow) {
      rightNow.textContent = '—';
      scoreNow.textContent = '—';
      confNow.textContent = '—';
      return;
    }

    const s = nowRow.sun_score;
    const c = nowRow.confidence;

    scoreNow.textContent = Math.round(s);
    scoreNow.className = 'value ' + scoreClass(s, threshold);

    confNow.textContent = Math.round(c * 100) + '%';

    if (s >= threshold) {
      rightNow.textContent = 'Go now';
      rightNow.className = 'big good';
    } else if (s >= threshold - 15) {
      rightNow.textContent = 'Maybe soon';
      rightNow.className = 'big warn';
    } else {
      rightNow.textContent = 'Wait';
      rightNow.className = 'big bad';
    }
  }

  function renderNextWindow(win) {
    if (!win) {
      nextWindow.textContent = 'No sunny window';
      nextWindow.className = 'big bad';
      nextWindowSub.textContent = 'Try a lower threshold or check later.';
      return;
    }

    const a = fmtTime(win.start);
    const b = fmtTime(win.end);

    nextWindow.textContent = `${a} – ${b}`;
    nextWindow.className = 'big good';
    nextWindowSub.textContent = `${win.minutes} minutes above threshold`;
  }

  function renderTimeline(dayRows, threshold) {
    timelineEl.innerHTML = '';

    // Daylight only
    const rows = dayRows.filter(r => r.elevation > 0);

    for (const r of rows) {
      const t = fmtTime(r.time_local);
      const s = Math.round(r.sun_score);
      const cls = scoreClass(s, threshold);

      const el = document.createElement('div');
      el.className = 'trow';

      const left = document.createElement('div');
      left.textContent = t;
      left.className = 'muted';

      const mid = document.createElement('div');
      const label = document.createElement('div');
      label.textContent = s;
      label.className = cls;

      const bar = document.createElement('div');
      bar.className = 'bar';
      const fill = document.createElement('div');
      fill.style.width = clamp(s, 0, 100) + '%';
      bar.appendChild(fill);

      mid.appendChild(label);
      mid.appendChild(bar);

      const right = document.createElement('div');
      right.textContent = Math.round(r.confidence * 100) + '%';
      right.className = 'muted';

      el.appendChild(left);
      el.appendChild(mid);
      el.appendChild(right);

      timelineEl.appendChild(el);
    }
  }

  function renderChart(dayRows, threshold) {
    // Plot elevation curve, and shade segments where sun_score >= threshold.
    const w = canvas.width;
    const h = canvas.height;

    ctx.clearRect(0, 0, w, h);

    const rows = dayRows;
    if (!rows.length) return;

    const elevs = rows.map(r => r.elevation);
    const maxElev = Math.max(...elevs, 1);

    // axis baseline
    ctx.globalAlpha = 0.25;
    ctx.beginPath();
    ctx.moveTo(0, h - 25);
    ctx.lineTo(w, h - 25);
    ctx.strokeStyle = 'white';
    ctx.lineWidth = 1;
    ctx.stroke();
    ctx.globalAlpha = 1;

    function yOf(e) {
      const yy = (h - 40) - (e / maxElev) * (h - 60);
      return clamp(yy, 10, h - 25);
    }

    // Highlight sunny segments
    ctx.lineWidth = 6;
    for (let i = 1; i < rows.length; i++) {
      const a = rows[i-1], b = rows[i];
      if (a.elevation <= 0 && b.elevation <= 0) continue;

      const sunny = (a.sun_score >= threshold) && (b.sun_score >= threshold);
      if (!sunny) continue;

      const x1 = (i-1) / (rows.length - 1) * w;
      const x2 = i / (rows.length - 1) * w;
      ctx.beginPath();
      ctx.moveTo(x1, yOf(a.elevation));
      ctx.lineTo(x2, yOf(b.elevation));
      const grad = ctx.createLinearGradient(0, 0, w, 0);
      grad.addColorStop(0, '#ff8c72');
      grad.addColorStop(0.5, '#f4b860');
      grad.addColorStop(1, '#ff8c72');
      ctx.strokeStyle = grad;
      ctx.stroke();
    }

    // Elevation line
    ctx.lineWidth = 2;
    ctx.beginPath();
    for (let i = 0; i < rows.length; i++) {
      const r = rows[i];
      const x = i / (rows.length - 1) * w;
      const y = yOf(Math.max(0, r.elevation));
      if (i === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    }
    ctx.strokeStyle = 'rgba(0,0,0,0.45)';
    ctx.stroke();

    // Draw sunny segments on top of the elevation line
    ctx.lineWidth = 6;
    ctx.lineCap = 'round';
    for (let i = 1; i < rows.length; i++) {
      const a = rows[i-1], b = rows[i];
      if (a.elevation <= 0 && b.elevation <= 0) continue;
      const sunny = (a.sun_score >= threshold) && (b.sun_score >= threshold);
      if (!sunny) continue;
      const x1 = (i-1) / (rows.length - 1) * w;
      const x2 = i / (rows.length - 1) * w;
      ctx.beginPath();
      ctx.moveTo(x1, yOf(a.elevation));
      ctx.lineTo(x2, yOf(b.elevation));
      const gradTop = ctx.createLinearGradient(0, 0, w, 0);
      gradTop.addColorStop(0, '#ff8c72');
      gradTop.addColorStop(0.5, '#f4b860');
      gradTop.addColorStop(1, '#ff8c72');
      ctx.strokeStyle = gradTop;
      ctx.stroke();
    }

    // update chart title in DOM (matches page font)
    const titleEl = document.getElementById('chartTitle');
    if (titleEl) titleEl.textContent = `Elevation (°) — sunny segments ≥ ${threshold}`;
  }

  function nearestNowRow(dayRows) {
    const now = new Date();
    let best = null;
    let bestDt = Infinity;
    for (const r of dayRows) {
      const t = new Date(r.time_local);
      const dt = Math.abs(t - now);
      if (dt < bestDt) { bestDt = dt; best = r; }
    }
    return best;
  }

  function cacheKey(lat, lon, threshold) {
    // round to avoid tiny GPS jitter exploding the cache
    const rlat = Number(lat).toFixed(4);
    const rlon = Number(lon).toFixed(4);
    const thr = Number(threshold);
    return `iwannasun_day_${rlat}_${rlon}_${thr}`;
  }

  function loadCached(lat, lon, threshold, maxAgeMs = 5 * 60 * 1000) {
    try {
      const key = cacheKey(lat, lon, threshold);
      const raw = sessionStorage.getItem(key);
      if (!raw) return null;
      const obj = JSON.parse(raw);
      if (!obj || !obj.ts || !obj.data) return null;
      if (Date.now() - obj.ts > maxAgeMs) return null;
      return obj.data;
    } catch {
      return null;
    }
  }

  function saveCached(lat, lon, threshold, data) {
    try {
      const key = cacheKey(lat, lon, threshold);
      sessionStorage.setItem(key, JSON.stringify({ ts: Date.now(), data }));
    } catch {
      // ignore quota / privacy mode
    }
  }

  async function fetchDay(force = false) {
    clearError();

    const lat = state.lat;
    const lon = state.lon;
    if (lat == null || lon == null) {
      showError('No location set');
      return;
    }

    const threshold = Number(thresholdEl.value);

    locPill.textContent = `${lat.toFixed(4)}, ${lon.toFixed(4)}`;

    const url = `${API_BASE}/day?lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&threshold=${encodeURIComponent(threshold)}&days=2`;

    // Avoid hammering the API (and reduces hosting usage during testing)
    if (!force) {
      const cached = loadCached(lat, lon, threshold);
      if (cached) {
        state.data = cached;
        render();
        return;
      }
    }

    try {
      const res = await fetch(url);
      if (!res.ok) {
        throw new Error(`API error ${res.status}`);
      }
      const data = await res.json();
      state.data = data;
      saveCached(lat, lon, threshold, data);
      render();
    } catch (e) {
      showError('Failed to fetch. Try again.');
      console.error(e);
    }
  }

  function render() {
    if (!state.data) return;

    const threshold = Number(thresholdEl.value);
    const dayIndex = Number(daySelect.value);

    const rows = state.data.timeline.filter(r => r.day_index === dayIndex);

    const nowRow = nearestNowRow(rows);
    renderDecision(nowRow, threshold);

    // use client-side next window (currently)
    const win = computeNextWindow(rows, threshold);
    renderNextWindow(win);

    // sun minutes from backend (based on now UTC)
    if (state.data.sun_minutes) {
      sun60.textContent = state.data.sun_minutes['60'] ?? '—';
      sun120.textContent = state.data.sun_minutes['120'] ?? '—';
    }

    renderChart(rows, threshold);
    renderTimeline(rows, threshold);
  }

  function useDemo() {
    state.lat = 52.3676;
    state.lon = 4.9041;
    fetchDay();
  }

  function useHere() {
    if (!navigator.geolocation) {
      showError('Geolocation not supported');
      return;
    }
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        state.lat = pos.coords.latitude;
        state.lon = pos.coords.longitude;
        fetchDay();
      },
      (err) => {
        showError('Location permission denied');
        console.warn(err);
      },
      { enableHighAccuracy: true, timeout: 10000 }
    );
  }

  document.getElementById('btnDemo').addEventListener('click', useDemo);
  document.getElementById('btnHere').addEventListener('click', useHere);
  document.getElementById('btnRefresh').addEventListener('click', () => fetchDay(true));

  thresholdEl.addEventListener('change', () => {
    if (state.data) render();
  });
  daySelect.addEventListener('change', () => {
    if (state.data) render();
  });

  // load demo on start
  useDemo();
</script>
</body>
</html>
