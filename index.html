<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>iwannasun</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; line-height: 1.35; }
    h1 { margin: 0 0 8px 0; }
    .muted { color: #666; font-size: 14px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; margin: 12px 0; }
    button, input { font-size: 16px; padding: 10px 12px; }
    button { cursor: pointer; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 12px; margin: 12px 0; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 13px; }
    .ok { color: #0a7; }
    .bad { color: #c22; }
    .timeline { max-height: 55vh; overflow: auto; }
    .item { display: flex; justify-content: space-between; gap: 10px; padding: 8px 0; border-bottom: 1px solid #f0f0f0; }
    .pill { padding: 2px 8px; border-radius: 999px; border: 1px solid #ddd; font-size: 13px; }
  </style>
</head>
<body>
  <h1>iwannasun</h1>
  <div class="muted">Direct sun probability — simple MVP</div>

  <div class="card">
    <div class="row">
      <button id="locBtn">Use my location</button>
      <button id="demoBtn">Demo (Amsterdam)</button>
    </div>

    <div class="row">
      <label class="muted">Sunny threshold (0–100)</label>
      <input id="threshold" type="number" min="0" max="100" value="70" style="width: 110px;">
    </div>

    <div class="muted">API:</div>
    <div class="mono" id="apiUrl">https://iwannasun.onrender.com</div>
    <div class="muted">(If your API URL changes, edit it in this file.)</div>
  </div>

  <div class="card">
    <div id="status" class="muted">Waiting…</div>
  </div>
  
  <div class="card">
    <h3 style="margin:0 0 8px 0;">Right now</h3>
    <div id="decision" style="font-size:18px;">—</div>
    <div id="decisionSub" class="muted"></div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px 0;">Next sunny window</h3>
    <div id="nextWindow" class="muted">—</div>
  </div>
  
  <div class="card">
    <div style="display:flex; align-items:baseline; justify-content:space-between; gap:12px;">
      <h3 style="margin:0;">Sun path today</h3>
      <div class="muted" style="font-size:12px;">
        Highlight when sun_score ≥ <span id="thrLabel">70</span>
      </div>
    </div>

    <canvas id="sunChart" style="width:100%; height:260px; display:block; margin-top:10px; border:1px solid #eee; border-radius:10px;"></canvas>

    <div class="muted" style="font-size:12px; margin-top:8px;">
      Gray = blocked/weak direct sun • Orange = likely direct sun • Line = sun elevation
    </div>
  </div>

  <div class="card timeline">
    <h3 style="margin:0 0 8px 0;">Today (daylight only, 10-min steps)</h3>
    <div id="timeline"></div>
  </div>

<script>
  // Small helper to grab elements
  function $(id) { return document.getElementById(id); }

  const statusEl = $("status");
  const decisionEl = $("decision");
  const decisionSubEl = $("decisionSub");
  const nextWindowEl = $("nextWindow");
  const timelineEl = $("timeline");
  const thrInput = $("threshold");
  const thrLabel = $("thrLabel");

  // ===== Canvas Sun Path Chart (no libraries) =====
  function clamp(v, min, max) {
    return Math.max(min, Math.min(max, v));
  }

  function parseMs(iso) {
    const ms = new Date(iso).getTime();
    return Number.isFinite(ms) ? ms : NaN;
  }

  function fmtHM(dateObj) {
    const hh = String(dateObj.getHours()).padStart(2, "0");
    const mm = String(dateObj.getMinutes()).padStart(2, "0");
    return `${hh}:${mm}`;
  }

  function getDPR() {
    return window.devicePixelRatio || 1;
  }

  function setupCanvas(canvas) {
    const ctx = canvas.getContext("2d");
    const dpr = getDPR();

    const cssW = canvas.clientWidth;
    const cssH = canvas.clientHeight;

    canvas.width = Math.round(cssW * dpr);
    canvas.height = Math.round(cssH * dpr);

    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    ctx.clearRect(0, 0, cssW, cssH);

    return { ctx, w: cssW, h: cssH };
  }

  let __lastDayDataForChart = null;

  function drawSunChart(data) {
    const canvas = $("sunChart");
    if (!canvas) return;

    const thr = Number(thrInput.value || 70);
    if (thrLabel) thrLabel.textContent = String(thr);

    const tl = data.timeline || [];
    if (!Array.isArray(tl) || tl.length < 2) return;

    const pts = tl.map(p => ({
      ms: parseMs(p.time_utc),
      elev: Number(p.elevation),
      score: Number(p.sun_score)
    }))
    .filter(p => Number.isFinite(p.ms) && Number.isFinite(p.elev) && Number.isFinite(p.score))
    .sort((a, b) => a.ms - b.ms);

    if (pts.length < 2) return;

    const tMin = pts[0].ms;
    const tMax = pts[pts.length - 1].ms;

    const eMax = Math.max(5, Math.ceil(Math.max(...pts.map(p => p.elev))));
    const eMin = 0;

    const { ctx, w, h } = setupCanvas(canvas);

    const pad = { left: 46, right: 14, top: 16, bottom: 28 };
    const left = pad.left, right = w - pad.right;
    const top = pad.top, bottom = h - pad.bottom;

    // Background
    ctx.fillStyle = "#fff";
    ctx.fillRect(0, 0, w, h);

    // Plot border
    ctx.strokeStyle = "#ddd";
    ctx.lineWidth = 1;
    ctx.strokeRect(left, top, right - left, bottom - top);

    // Grid + elevation labels
    ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.fillStyle = "#444";
    ctx.strokeStyle = "#eee";
    ctx.lineWidth = 1;

    const gridLines = 4;
    for (let i = 0; i <= gridLines; i++) {
      const u = i / gridLines;
      const y = top + (bottom - top) * (1 - u);

      ctx.beginPath();
      ctx.moveTo(left, y);
      ctx.lineTo(right, y);
      ctx.stroke();

      const elevVal = Math.round(eMin + (eMax - eMin) * u);
      ctx.fillText(`${elevVal}°`, 6, y + 4);
    }

    // Time labels
    const startD = new Date(tMin);
    const midD = new Date((tMin + tMax) / 2);
    const endD = new Date(tMax);

    ctx.fillStyle = "#444";
    ctx.fillText(fmtHM(startD), left, h - 8);
    ctx.fillText(fmtHM(midD), (left + right) / 2 - 16, h - 8);
    ctx.fillText(fmtHM(endD), right - 40, h - 8);

    function xFromMs(ms) {
      const u = (ms - tMin) / (tMax - tMin);
      return left + u * (right - left);
    }

    function yFromElev(elev) {
      const v = (elev - eMin) / (eMax - eMin);
      return bottom - v * (bottom - top);
    }

    // Next sunny window shading
    const win = data.next_sunny_window;
    if (win && win.start && win.end) {
      const s = parseMs(win.start);
      const e = parseMs(win.end);
      if (Number.isFinite(s) && Number.isFinite(e)) {
        const sC = clamp(s, tMin, tMax);
        const eC = clamp(e, tMin, tMax);
        if (eC > sC) {
          const x1 = xFromMs(sC);
          const x2 = xFromMs(eC);

          ctx.fillStyle = "rgba(246, 183, 60, 0.12)";
          ctx.fillRect(x1, top, x2 - x1, bottom - top);

          ctx.strokeStyle = "rgba(246, 183, 60, 0.45)";
          ctx.lineWidth = 1;
          ctx.beginPath();
          ctx.moveTo(x1, top); ctx.lineTo(x1, bottom);
          ctx.moveTo(x2, top); ctx.lineTo(x2, bottom);
          ctx.stroke();
        }
      }
    }

    // Curve segments colored by sun_score
    const sunnyColor = "#f6b73c";
    const grayColor = "rgba(120,120,120,0.55)";

    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.lineJoin = "round";

    for (let i = 0; i < pts.length - 1; i++) {
      const a = pts[i];
      const b = pts[i + 1];

      const aElev = Math.max(0, a.elev);
      const bElev = Math.max(0, b.elev);

      const x1 = xFromMs(a.ms);
      const y1 = yFromElev(aElev);
      const x2 = xFromMs(b.ms);
      const y2 = yFromElev(bElev);

      const isSunny = (a.score >= thr) && (aElev > 0.1);
      ctx.strokeStyle = isSunny ? sunnyColor : grayColor;

      ctx.beginPath();
      ctx.moveTo(x1, y1);
      ctx.lineTo(x2, y2);
      ctx.stroke();
    }

    // "now" marker
    const now = Date.now();
    if (now >= tMin && now <= tMax) {
      const x = xFromMs(now);
      ctx.strokeStyle = "rgba(0,0,0,0.35)";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(x, top);
      ctx.lineTo(x, bottom);
      ctx.stroke();

      ctx.fillStyle = "rgba(0,0,0,0.7)";
      ctx.fillText("now", x + 6, top + 14);
    }
  }
  // ===== end chart code =====

  window.addEventListener("resize", () => {
    if (__lastDayDataForChart) drawSunChart(__lastDayDataForChart);
  });

  function setDecision(goNow, sub) {
    decisionEl.textContent = goNow ? "Go now" : "Wait";
    decisionEl.style.color = goNow ? "#0a7" : "#d60";
    decisionSubEl.textContent = sub || "";
  }

  function render(data) {
    const thr = Number(thrInput.value || 70);

    const nowPoint = (data.timeline || [])[0];
    if (nowPoint) {
      const goNow = Number(nowPoint.sun_score) >= thr && Number(nowPoint.elevation) > 0.1;
      setDecision(
        goNow,
        `sun_score=${Math.round(nowPoint.sun_score)} • elevation=${Number(nowPoint.elevation).toFixed(1)}°`
      );
    } else {
      setDecision(false, "No data");
    }

    if (data.next_sunny_window && data.next_sunny_window.start && data.next_sunny_window.end) {
      const s = new Date(data.next_sunny_window.start);
      const e = new Date(data.next_sunny_window.end);
      nextWindowEl.textContent = `${fmtHM(s)}–${fmtHM(e)} (local time)`;
    } else {
      nextWindowEl.textContent = "No sunny window found today.";
    }

    const rows = (data.timeline || [])
      .filter(p => Number(p.elevation) > 0)
      .map(p => {
        const t = new Date(p.time_utc);
        const hm = fmtHM(t);
        const s = Math.round(p.sun_score);
        const e = Number(p.elevation).toFixed(1);
        const c = p.cloud ? `L${p.cloud.low}/M${p.cloud.mid}/H${p.cloud.high}` : "";
        return `<div style="display:flex; justify-content:space-between; gap:12px;">
                  <div>${hm}</div>
                  <div class="muted">elev ${e}°</div>
                  <div class="muted">score ${s}</div>
                  <div class="muted">${c}</div>
                </div>`;
      })
      .join("");

    timelineEl.innerHTML = rows || `<div class="muted">No daylight points.</div>`;

    __lastDayDataForChart = data;
    drawSunChart(data);

    statusEl.textContent =
      `Loaded. Daylight points: ${(data.timeline || []).filter(p => Number(p.elevation) > 0).length}`;
  }

  async function fetchDay(lat, lon) {
    const thr = Number(thrInput.value || 70);
    statusEl.textContent = "Loading…";

    const base = "https://iwannasun.onrender.com";
    const url = `${base}/day?lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&threshold=${encodeURIComponent(thr)}`;

    const res = await fetch(url);
    if (!res.ok) throw new Error(`API error ${res.status}`);
    return await res.json();
  }

  async function run(lat, lon) {
    try {
      const data = await fetchDay(lat, lon);
      render(data);
    } catch (err) {
      console.error(err);
      statusEl.textContent = `Error: ${err.message}`;
    }
  }

  $("useDemo").addEventListener("click", () => run(52.3676, 4.9041));

  $("useMyLocation").addEventListener("click", () => {
    statusEl.textContent = "Requesting location…";
    navigator.geolocation.getCurrentPosition(
      (pos) => run(pos.coords.latitude, pos.coords.longitude),
      (err) => {
        console.error(err);
        statusEl.textContent = "Location denied or unavailable.";
      },
      { enableHighAccuracy: true, timeout: 10000 }
    );
  });

  thrInput.addEventListener("change", () => {
    if (__lastDayDataForChart) drawSunChart(__lastDayDataForChart);
  });
</script>

</body>
</html>
